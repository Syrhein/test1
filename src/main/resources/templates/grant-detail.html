<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì§€ì›ê¸ˆ ìƒì„¸ ì •ë³´</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .sub-info {
            font-size: 14px;
            color: gray;
            margin-top: -10px;
            margin-bottom: 10px;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .ongoing {
            background-color: #4CAF50;
            color: white;
        }
        .closed {
            background-color: #d9534f;
            color: white;
        }
        .btn-container {
            margin-top: 20px;
            text-align: center;
        }
        .btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <h1 id="grantTitle">ì§€ì›ê¸ˆ ìƒì„¸ ì •ë³´</h1>
    <p class="sub-info">
        <span id="grantLocation" class="status">ì§€ì—­ ì •ë³´ ì—†ìŒ</span> | 
        <span id="grantStatus" class="status"></span>
    </p>

    <table>
        <tr>
            <th>ì‹ ì²­ê¸°ê°„</th>
            <td id="grantPeriod"></td>
        </tr>
        <tr>
            <th>ì£¼ê´€ê¸°ê´€</th>
            <td id="grantAgency"></td>
        </tr>
        <tr>
            <th>ëŒ€ìƒ</th>
            <td id="grantTarget"></td>
        </tr>
        <tr>
            <th>ë‹´ë‹¹ë¶€ì„œ</th>
            <td id="grantDept"></td>
        </tr>
		<tr>
	    	<th>ìš”ì•½ë‚´ìš©</th>
	    	<td id="grantContent"></td>
		</tr>
    </table>
    <div class="btn-container">
        <a href="/grants" class="btn">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        <a id="infoUrlBtn" href="#" class="btn" target="_blank" style="display: none;">ê³µë¬¸ë³´ê¸°</a>
        <button id="interestBtn" class="btn">ê´€ì‹¬ ë“±ë¡</button>
    </div>


    <script>
    $(document).ready(function() {
        let seq = "[[${seq}]]";  // Thymeleafì—ì„œ ì „ë‹¬ëœ seq ê°’
        console.log("ğŸ“Œ ìƒì„¸ í˜ì´ì§€ seq ê°’:", seq);

        $.ajax({
            url: "https://apis.data.go.kr/1390000/youngV2/policyViewV2?typeDv=json&serviceKey=lwFN%2B9DgtdnDkUuQpxCaemhEBXNKBw%2FEIeII2WsOlInuroAHa9InabfXhyR365jieyuEEzrb2QYAHP3b3AlrFA%3D%3D&seq=" + seq,
            type: "GET",
            dataType: "json",
            success: function(response) {
                console.log("ğŸ“Œ ìƒì„¸ API ì‘ë‹µ ë°ì´í„°:", response);

                let grant = response.policy_result;

                $("#grantTitle").text(grant.title || "ì œëª© ì—†ìŒ");
                $("#grantPeriod").text((grant.applStDt || "ê¸°ê°„ ì—†ìŒ") + " ~ " + (grant.applEdDt || "ê¸°ê°„ ì—†ìŒ"));
                $("#grantAgency").text(grant.chargeAgency || "ê¸°ê´€ ì •ë³´ ì—†ìŒ");
                $("#grantTarget").text(grant.eduTarget || "ëŒ€ìƒ ì •ë³´ ì—†ìŒ");
                $("#grantDept").text(grant.chargeDept || "ë‹´ë‹¹ ë¶€ì„œ ì •ë³´ ì—†ìŒ");
                
            	// ë‚´ìš© í‘œì‹œ (ê°œí–‰ ë¬¸ì \n â†’ <br> íƒœê·¸ ë³€í™˜)
                let formattedContent = (grant.contents || "ë‚´ìš© ì—†ìŒ").replace(/\n/g, "<br>");
                $("#grantContent").html(formattedContent);

                // ì§€ì—­ ì •ë³´ ì¶”ê°€ (null ë˜ëŠ” ë¹ˆ ê°’ì´ë©´ "ì „êµ­"ìœ¼ë¡œ ì„¤ì •)
                let locationText = grant.area2Nm && grant.area2Nm.trim() ? grant.area2Nm : "ì „êµ­";
                $("#grantLocation").text(locationText);

                // í˜„ì¬ ìƒíƒœ (ì§„í–‰ ì¤‘ / ë§ˆê°) ê³„ì‚°
                let today = new Date();
                let endDate = new Date(grant.applEdDt);
                if (!isNaN(endDate.getTime()) && today <= endDate) {
                    $("#grantStatus").text("ì§„í–‰ ì¤‘").addClass("ongoing");
                } else {
                    $("#grantStatus").text("ë§ˆê°").addClass("closed");
                }

                // ê³µë¬¸ë³´ê¸° ë²„íŠ¼ ì„¤ì • (infoUrlì´ ìˆì„ ê²½ìš°)
                if (grant.infoUrl && grant.infoUrl.trim()) {
                    $("#infoUrlBtn").attr("href", grant.infoUrl).show();
                }
            },
            error: function() {
                alert("ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });
    </script>
    
    <script>
    $(document).ready(function() {
        let userId = "testUser"; // â˜… ë¡œê·¸ì¸í•œ ìœ ì € ID (ì„ì‹œ ê°’)
        let grantId = "[[${seq}]]";
        let applEdDt = $("#grantPeriod").text().split("~")[1].trim(); // ë§ˆê°ì¼

        $("#interestBtn").click(function() {
            $.post("/api/interest/add", { userId, grantId, applEdDt })
                .done(function(response) {
                    alert(response);
                })
                .fail(function() {
                    alert("ê´€ì‹¬ ë“±ë¡ ì‹¤íŒ¨!");
                });
        });
    });
</script>

</body>
</html>
