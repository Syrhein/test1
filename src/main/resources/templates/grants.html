<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì •ë¶€ ì§€ì›ê¸ˆ ëª©ë¡</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="/css/grant.css">
</head>
<body>

	<h1>ì •ë¶€ ì§€ì›ê¸ˆ ëª©ë¡</h1>

	<!-- ğŸ” ê²€ìƒ‰ ë° ì„¸ë¶€ í•„í„° -->
	<div class="filter-container">
		<input type="text" id="searchKeyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">

		<!-- ğŸŒ ì§€ì—­ í•„í„° -->
		<select id="searchArea">
			<option value="ì „êµ­">ì „êµ­</option>
			<option value="ì„œìš¸">ì„œìš¸</option>
			<option value="ë¶€ì‚°">ë¶€ì‚°</option>
			<option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
			<option value="ì¸ì²œ">ì¸ì²œ</option>
			<option value="ê´‘ì£¼">ê´‘ì£¼</option>
			<option value="ëŒ€ì „">ëŒ€ì „</option>
			<option value="ìš¸ì‚°">ìš¸ì‚°</option>
			<option value="ì„¸ì¢…">ì„¸ì¢…</option>
			<option value="ê²½ê¸°">ê²½ê¸°</option>
			<option value="ê°•ì›">ê°•ì›</option>
			<option value="ì¶©ë¶">ì¶©ë¶</option>
			<option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
			<option value="ì „ë¶">ì „ë¶</option>
			<option value="ì „ë‚¨">ì „ë‚¨</option>
			<option value="ê²½ë¶">ê²½ë¶</option>
			<option value="ê²½ë‚¨">ê²½ë‚¨</option>
			<option value="ì œì£¼">ì œì£¼</option>
		</select>


		<!-- ğŸ“… ì‹ ì²­ ê¸°ê°„ í•„í„° -->
		<input type="date" id="startDate"> <input type="date"
			id="endDate">

		<!-- ğŸ“Œ ì§„í–‰ ìƒíƒœ í•„í„° -->
		<select id="searchStatus">
			<option value="">ì§„í–‰ ìƒíƒœ</option>
			<option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
			<option value="ë§ˆê°">ë§ˆê°</option>
		</select>

		<!-- ğŸ”„ ì •ë ¬ ë°©ì‹ -->
		<select id="sortOrder">
			<option value="">ì •ë ¬ ë°©ì‹ ì„ íƒ</option>
			<option value="regDate">ë“±ë¡ì¼ìˆœ</option>
			<option value="closeDate">ë§ˆê°ì¼ìˆœ</option>
			<option value="price">ì§€ì›ê¸ˆì•¡ìˆœ</option>
		</select>





		<!-- ğŸ” ê²€ìƒ‰ ë²„íŠ¼ -->
		<button id="searchBtn">ê²€ìƒ‰</button>
	</div>


	<!-- ğŸ”¹ ì§€ì›ê¸ˆ ëª©ë¡ ì¹´ë“œë·° -->
	<div class="card-container" id="grantList">
		<!-- JavaScriptì—ì„œ ì§€ì›ê¸ˆ ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ì‚½ì…ë¨ -->
	</div>

	<!-- ğŸ”¢ í˜ì´ì§€ë„¤ì´ì…˜ -->
	<ul class="pagination" id="pagination"></ul>



	<!-- ì§€ì—­ ì½”ë“œ ë§¤í•‘ -->
	<script>
const regionCodes = {
	    "ì „êµ­": "00",
	    "ì„œìš¸": "11",
	    "ë¶€ì‚°": "21",
	    "ëŒ€êµ¬": "22",
	    "ì¸ì²œ": "23",
	    "ê´‘ì£¼": "24",
	    "ëŒ€ì „": "25",
	    "ìš¸ì‚°": "26",
	    "ì„¸ì¢…": "29",
	    "ê²½ê¸°": "31",
	    "ê°•ì›": "32",
	    "ì¶©ë¶": "33",
	    "ì¶©ë‚¨": "34",
	    "ì „ë¶": "35",
	    "ì „ë‚¨": "36",
	    "ê²½ë¶": "37",
	    "ê²½ë‚¨": "38",
	    "ì œì£¼": "39"
	};

</script>



	<!-- ìš”ì²­ URL ìƒì„± -->
	<script>
function buildApiUrl(page = 1) {
    let baseUrl = "https://apis.data.go.kr/1390000/youngV2/policyListV2";
    let params = [];

    // âœ… ê³ ì •ëœ í•„ìˆ˜ íŒŒë¼ë¯¸í„°
    params.push("typeDv=json");
    params.push("serviceKey=lwFN%2B9DgtdnDkUuQpxCaemhEBXNKBw%2FEIeII2WsOlInuroAHa9InabfXhyR365jieyuEEzrb2QYAHP3b3AlrFA%3D%3D");
    params.push(`rowCnt=${itemsPerPage}`);
    params.push(`cp=${page}`);

    // âœ… ë™ì  ì¶”ê°€ íŒŒë¼ë¯¸í„°
    let keyword = $("#searchKeyword").val();
    let area = $("#searchArea").val();
    let startDate = $("#startDate").val();
    let endDate = $("#endDate").val();
    let status = $("#searchStatus").val();
    let minPrice = $("#minPrice").val();
    let maxPrice = $("#maxPrice").val();
    let sortOrder = $("#sortOrder").val();

    if (keyword) params.push(`search_keyword=${encodeURIComponent(keyword)}`);

    // âœ… ì§€ì—­ ì„ íƒê°’ì„ ì§€ì—­ ì½”ë“œë¡œ ë³€í™˜í•˜ì—¬ ì¶”ê°€
    if (area && regionCodes[area]) {
        params.push(`search_area1=${regionCodes[area]}`);
    }

    if (startDate) params.push(`sd=${startDate}`);
    if (endDate) params.push(`ed=${endDate}`);
    if (status) params.push(`search_status=${encodeURIComponent(status)}`);
    if (minPrice) params.push(`minPrice=${minPrice}`);
    if (maxPrice) params.push(`maxPrice=${maxPrice}`);
    if (sortOrder) params.push(`sort=${sortOrder}`);

    let finalUrl = `${baseUrl}?${params.join("&")}`;
    console.log("ğŸ“Œ API ìš”ì²­ URL:", finalUrl);

    return finalUrl;
}


</script>


	<!-- API í˜¸ì¶œ -->
	<script>
    let currentPage = 1; // í˜„ì¬ í˜ì´ì§€ ì €ì¥
    let itemsPerPage = 10; // í•œ í˜ì´ì§€ë‹¹ ê°œìˆ˜

    function fetchGrants(page = 1) {
        currentPage = page; // í˜„ì¬ í˜ì´ì§€ ì €ì¥
        let apiUrl = buildApiUrl(page); // âœ… ë™ì ìœ¼ë¡œ URL ìƒì„±

        $.ajax({
            url: apiUrl,
            type: "GET",
            dataType: "json",
            success: function(response) {
                console.log("ğŸ“Œ API ì‘ë‹µ ë°ì´í„°:", response);
                renderGrantList(response.policy_list);
                let totalItems = response.policy_paging?.totalCount || 0;
                let totalPages = Math.ceil(totalItems / itemsPerPage);
                renderPagination(totalPages, page);
            },
            error: function() {
                alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

</script>

	<!-- ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ -->
	<script>
function renderGrantList(grants) {
    let html = "";
    if (grants && grants.length > 0) {
        grants.forEach(function(grant) {
            let status = getStatus(grant.applEdDt); // âœ… ì§„í–‰ ìƒíƒœ ê³„ì‚°

            html += `
                <div class="card">
                    <h3>${grant.title || "ì œëª© ì—†ìŒ"}</h3>
                    <p><strong>ëŒ€ìƒ:</strong> ${grant.eduTarget || "ëŒ€ìƒ ì •ë³´ ì—†ìŒ"}</p>
                    <p><strong>ì‹ ì²­ ê¸°ê°„:</strong> ${grant.applStDt || "ê¸°ê°„ ì—†ìŒ"} ~ ${grant.applEdDt || "ê¸°ê°„ ì—†ìŒ"}</p>
                    <p><strong>ì§„í–‰ ìƒíƒœ:</strong> <span class="${status === 'ì§„í–‰ì¤‘' ? 'ongoing' : 'closed'}">${status}</span></p>
                    <p><a href="/grants/detail/${grant.seq}">ìƒì„¸ë³´ê¸°</a></p>
                </div>
            `;
        });
    } else {
        html = "<p>âš  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    }

    $("#grantList").html(html);
}

</script>

	<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
	<script>
    function renderPagination(totalPages, currentPage) {
        let paginationHtml = "";

        if (totalPages > 1) {
            // â® ì²« í˜ì´ì§€ ì´ë™ ë²„íŠ¼
            if (currentPage > 1) {
                paginationHtml += `<li onclick="changePage(1)">Â«</li>`;
            }

            // ğŸ”¢ í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ ì•ë’¤ 2ê°œ í˜ì´ì§€ë§Œ í‘œì‹œ
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHtml += `<li class="active">${i}</li>`;
                } else {
                    paginationHtml += `<li onclick="changePage(${i})">${i}</li>`;
                }
            }

            // â­ ë§ˆì§€ë§‰ í˜ì´ì§€ ì´ë™ ë²„íŠ¼
            if (currentPage < totalPages) {
                paginationHtml += `<li onclick="changePage(${totalPages})">Â»</li>`;
            }
        }

        $("#pagination").html(paginationHtml); // ê¸°ì¡´ í˜ì´ì§€ë„¤ì´ì…˜ ì œê±° í›„ ìƒˆë¡œ ë Œë”ë§
    }

    function changePage(page) {
        fetchGrants(page); // âœ… í˜ì´ì§€ ë³€ê²½ ì‹œ API í˜¸ì¶œ
    }
</script>

	<!-- ì§„í–‰,ë§ˆê° êµ¬ë¶„í•˜ê¸° -->
	<script>
function getStatus(applEdDt) {
    let today = new Date();
    let endDate = new Date(applEdDt);

    if (!applEdDt || isNaN(endDate)) {
        return "ì •ë³´ ì—†ìŒ";
    }

    return today <= endDate ? "ì§„í–‰ì¤‘" : "ë§ˆê°";
}
</script>



	<!-- ì²« í˜ì´ì§€ ê¸°ë³¸ê°’ í˜¸ì¶œ -->
	<script>
$(document).ready(function() {
    $("#searchBtn").click(function() {
        fetchGrants(1); // âœ… ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ 1í˜ì´ì§€ë¶€í„° ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
    });

    $("#sortOrder").change(function() {
        fetchGrants(1); // âœ… ì •ë ¬ ë³€ê²½ ì‹œ ì²« í˜ì´ì§€ë¶€í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    });

    fetchGrants(1); // âœ… í˜ì´ì§€ ë¡œë”© ì‹œ ê¸°ë³¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
});

</script>








</body>
</html>
